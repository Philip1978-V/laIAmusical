<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala 1 - Versión Unificada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Animaciones Personalizadas */
        @keyframes pulse-custom {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.3; }
        }
        @keyframes bounce-custom {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes blink-custom {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-custom { animation: pulse-custom 3s ease-in-out infinite; }
        .animate-bounce-custom { animation: bounce-custom 2s ease-in-out infinite; }
        .animate-blink-custom { animation: blink-custom 1s step-start infinite; }

        /* Animación para la nota junto al título */
        @keyframes bounce-sala1 {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); } /* Movimiento de 5px hacia arriba y abajo */
        }

        .animate-bounce-sala1 {
            animation: bounce-sala1 1.5s ease-in-out infinite;
        }

        .hidden { display: none; }
        
        /* Estilo para el reproductor de audio */
        audio::-webkit-media-controls-panel {
            background-color: #312e81; /* Indigo-800 */
            color: white;
        }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-mute-button {
            color: #fcd34d; /* Yellow-400 */
        }

        /* Animación para el icono flotante (DEPRECADO, se mantiene el código base de float) */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); } 
            100% { transform: translateY(0px); }
        }

        .animate-float {
            animation: float 2.5s ease-in-out infinite; 
        }
        
        .image-placeholder {
            /* Estilo para simular que la imagen carga */
            background-color: #1f2937; /* Gray-800 */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4b5563; /* Gray-500 */
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans">
    
   <header class="bg-indigo-950 p-4 shadow-xl sticky top-0 z-10 border-b border-indigo-800">
    <div class="container mx-auto flex flex-col items-center">
        
        <h1 class="text-xl md:text-3xl font-extrabold text-teal-400 flex items-center justify-center w-full mb-2">
            <svg class="w-6 h-6 md:w-8 md:h-8 mr-2 text-yellow-400 animate-bounce-sala1" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-8z"/>
            </svg>
            Sala 1
        </h1>
        
        <div class="w-full flex justify-between items-center mb-2 md:mb-4">
            
             <div class="flex items-center space-x-4 text-sm md:text-lg">
                <span class="text-cyan-400">Votos Restantes: <span id="votesRemainingDisplay" class="font-bold text-yellow-400">5</span></span>
                <span class="text-cyan-400 hidden sm:inline-block">|</span>
                <span class="text-cyan-400 flex items-center">Estrellas Acumuladas: <span id="userStarsDisplay" class="font-bold text-yellow-400 ml-1">0</span></span>
             </div>
             
             <div class="flex items-center space-x-2 md:space-x-4">
                <button onclick="openGlobalInfoModal()" class="bg-indigo-700 hover:bg-indigo-600 p-2 rounded-full transition-all hover:scale-105">
                    <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </button>
                
                <div class="relative" id="profileMenuContainer">
                    <button onclick="toggleProfileDropdown()" class="bg-emerald-600 hover:bg-emerald-700 p-2 rounded-full transition-all hover:scale-105">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </button>
                    
                    <div id="profileDropdown" class="absolute right-0 mt-2 w-48 bg-indigo-800 rounded-lg shadow-xl py-2 z-20 hidden border border-indigo-700">
                        <a onclick="openMissionModal()" class="block px-4 py-2 text-sm text-white hover:bg-indigo-700 cursor-pointer flex items-center gap-2">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.5 10l-4 4-2-2m0 0l-4 4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path></svg>
                             Nuestra Misión
                        </a>
                        <a href="perfil.html" class="block px-4 py-2 text-sm text-white hover:bg-indigo-700 flex items-center gap-2">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                             Perfil Usuario
                        </a>
                        <div class="border-t border-indigo-700 my-1"></div>
                        <a onclick="logout()" class="block px-4 py-2 text-sm text-red-400 hover:bg-indigo-700 cursor-pointer flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-3m0-6V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex items-center space-x-2 md:space-x-4 w-full justify-center">
            <a href="temas.html" class="bg-purple-600 hover:bg-purple-700 py-2 px-3 rounded-lg font-bold transition-all text-sm md:text-base hover:scale-105">Temas</a>
            <a href="archivos.html" class="bg-red-600 hover:bg-red-700 py-2 px-3 rounded-lg font-bold transition-all text-sm md:text-base hover:scale-105">Archivos</a>
            <a href="podcast.html" class="bg-pink-600 hover:bg-pink-700 py-2 px-3 rounded-lg font-bold transition-all text-sm md:text-base hover:scale-105">Podcast</a>
        </div>
        
    </div>
</header>

    <main class="container mx-auto p-6">
        
        <section class="mb-12">
            <h2 class="text-4xl font-extrabold text-center mb-8  text-yellow-400 drop-shadow-lg">🏆 Top 3: Lo más votado 🏆</h2>
            <div id="top3Container" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                </div>
        </section>

        <section>
            <h2 class="text-3xl font-bold text-center mb-8 text-teal-400">Resto del Ranking</h2>
            <div id="rankingContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
        </section>
    </main>
    
    <div id="infoModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-40 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-cyan-900 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto border-2 border-cyan-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-900 p-4 flex justify-end">
                <button onclick="closeInfoModal()" class="hover:bg-indigo-800 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="infoContent" class="p-6 text-white">
                </div>
        </div>
    </div>

    <div id="missionModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-40 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-purple-900 rounded-2xl max-w-xl w-full max-h-[90vh] overflow-y-auto border-2 border-purple-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-800 p-4 flex justify-between items-center border-b border-indigo-600">
                <h2 class="text-xl md:text-2xl font-bold text-white">Nuestra Misión</h2>
                <button onclick="closeMissionModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 text-white space-y-4">
                <p class="text-lg font-semibold text-yellow-300">¡Bienvenidos a Literatura Musical!</p>
                <p>Nuestra misión es conectar dos mundos aparentemente distintos pero profundamente relacionados: la **Literatura Clásica** y la **Música Contemporánea**.</p>
                <p>A través de adaptaciones musicales de obras icónicas, buscamos:</p>
                <ul class="list-disc list-inside space-y-2 ml-4 text-cyan-200">
                    <li>**Rejuvenecer** la apreciación por los grandes autores y sus textos.</li>
                    <li>Ofrecer una **experiencia sensorial única** que complemente la lectura.</li>
                    <li>Crear una **comunidad de votación** donde los usuarios decidan qué adaptaciones merecen estar en la cima.</li>
                    <li>**Incentivar el aprendizaje** de forma lúdica a través de los Quizzes.</li>
                    </ul>
                <p class="pt-4 text-sm text-gray-400">¡Gracias por formar parte de esta sinfonía de letras y melodías!</p>
            </div>
        </div>
    </div>
    
    <div id="globalInfoModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-40 p-4">
        <div class="bg-gradient-to-br from-indigo-950 to-indigo-800 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border-2 border-yellow-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-900 p-4 flex justify-between items-center border-b border-indigo-700">
                <h2 class="text-2xl font-bold text-yellow-400 flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Información y Comunidad
                </h2>
                <button onclick="closeGlobalInfoModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6 text-white space-y-8">
                
                <section class="border-b border-indigo-700 pb-6">
                    <h3 class="text-xl font-bold mb-3 text-teal-400 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                        Mecánica de Votación
                    </h3>
                    <ul class="list-disc list-inside space-y-2 ml-4 text-gray-300">
                        <li>Cada usuario dispone de **5 votos semanales** (límite en el apartado de votos).</li>
                        <li>Cada voto se realiza gastando una cantidad de estrellas: **5, 6, 7, 8, 9 o 10 estrellas**.</li>
                        <li>**Restricción clave:** Solo se puede votar con una cantidad de estrellas **igual o menor** a las estrellas que tienes acumuladas.</li>
                        <li>Las estrellas elegidas para votar se **restan** de tus estrellas acumuladas.</li>
                        <li>Tus votos restantes y estrellas acumuladas se muestran en la cabecera.</li>
                    </ul>
                </section>
                
                <section class="border-b border-indigo-700 pb-6">
                    <h3 class="text-xl font-bold mb-3 text-teal-400 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 002-2h2a2 2 0 002 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        Mecánica de Quiz y Estrellas Acumuladas
                    </h3>
                    <ul class="list-disc list-inside space-y-2 ml-4 text-gray-300">
                        <li>El **título**, **autor** y **año** de la obra están ocultos inicialmente.</li>
                        <li>Debes hacer clic en el botón **HACER QUIZZ** para participar.</li>
                        <li class="font-bold text-yellow-300">La información detallada se desbloquea si aciertas **1 o más preguntas**.</li>
                        <li>Los datos se guardan: una vez desbloqueada la información de una obra, se mantiene visible en el ranking.</li>
                        <li class="font-bold text-teal-400">Estrellas Acumuladas (Moneda):</li>
                        <ul class="list-disc list-inside ml-8 text-cyan-300">
                            <li>Se ganan **5 estrellas** por cada pregunta acertada.</li>
                            <li>Se ganan **10 estrellas mas de bonificación** si aciertas las 3 preguntas (máximo 25 estrellas).</li>
                            <li>Estas estrellas se acumulan en tu saldo (apartado Estrellas) para poder gastarlas en votos.</li>
                        </ul>
                    </ul>
                </section>

                <section>
                    <h3 class="text-xl font-bold mb-4 text-teal-400 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.208 5 7.5 5c-4.418 0-8 3.582-8 8s3.582 8 8 8 8-3.582 8-8c0-1.708-.477-3.332-1.253-4.75z"></path></svg>
                        Muro de Comentarios Globales
                    </h3>
                    <p class="text-sm text-gray-400 mb-4">¡Comparte tus pensamientos generales sobre la web o la música aquí!</p>
                    
                    <div class="mb-6">
                        <textarea id="globalCommentInput" placeholder="Añade un comentario global..." class="w-full bg-indigo-900/50 border border-indigo-600 rounded-lg p-3 text-white placeholder-indigo-400 focus:outline-none focus:border-indigo-400" rows="3"></textarea>
                        <button onclick="addGlobalComment()" class="mt-2 bg-pink-600 hover:bg-pink-700 px-4 py-2 rounded-lg font-bold transition">Añadir Comentario</button>
                    </div>
                    
                    <div id="globalCommentsContainer" class="space-y-3">
                        <p class="text-center text-gray-500 italic" id="noGlobalCommentsMessage">No hay comentarios aún. ¡Sé el primero en comentar!</p>
                    </div>
                </section>
                
            </div>
        </div>
    </div>
    
    <div id="voteSelectionModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-40 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-emerald-900 rounded-2xl max-w-sm w-full border-2 border-emerald-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-900 p-4 flex justify-between items-center border-b border-indigo-700">
                <h2 class="text-xl font-bold text-emerald-400">Elige la Cantidad de Estrellas para Votar</h2>
                <button onclick="closeVoteSelectionModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 text-white space-y-4">
                <p class="text-lg mb-4">Tienes **<span id="userStarsInModal" class="text-yellow-400 font-bold">0</span>** Estrellas Acumuladas.</p>
                <div id="voteOptionsContainer" class="grid grid-cols-3 gap-2">
                    </div>
                <p class="text-sm text-gray-400 pt-2">Solo puedes seleccionar valores de estrella que puedas pagar con tus estrellas acumuladas.</p>
            </div>
        </div>
    </div>


    <div id="lyricsModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-40 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-yellow-900 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border-2 border-yellow-400 shadow-2xl">
             <div class="sticky top-0 bg-indigo-900 p-4 flex justify-between items-center border-b border-indigo-700">
                <h2 class="text-2xl font-bold text-yellow-400" id="lyricsTitle">Letra de la Canción</h2>
                <button onclick="closeLyricsModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="lyricsContent" class="p-6 text-white whitespace-pre-wrap font-serif">
                </div>
        </div>
    </div>
    
    <div id="quizModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-red-900 rounded-2xl max-w-xl w-full max-h-[90vh] overflow-y-auto border-2 border-red-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-900 p-4 flex justify-between items-center border-b border-indigo-700">
                <h2 class="text-2xl font-bold text-red-400" id="quizTitle">Quiz de la Obra</h2>
                <button onclick="closeQuizModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="quizContent" class="p-6 text-white space-y-6">
                </div>
        </div>
    </div>


    <script>
        // --- DATA DE CANCIONES (BASE) ---
        var initialSongs = [
            { id: 1, title: "Veinte Poemas de Amor", author: "Pablo Neruda", year: 1924, image: "imagenportada/poemas.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1rDezgL9BLhX3x_u3WQnwIylyVQL3jraH/view?usp=drive_link", description: "Adaptación musical de los icónicos versos de amor de Neruda, transformando su melancolía en melodía.", comments: [], lyrics: `Para mi corazón basta tu pecho,
            Para tu libertad bastan mis alas.
            Desde mi boca llegará hasta el cielo
            lo que estaba dormido sobre tu alma.
            
            Es la hora de la partida, la dura y fría hora
            que la noche sujeta a todo horario.
            El cuerpo de la amada se queda conmigo,
            su ausencia ha sembrado la casa de dudas.`, quizData: { author: "Pablo Neruda", title: "Veinte Poemas de Amor y una Canción Desesperada", prizes: ["Premio Nobel de Literatura", "Premio Cervantes", "Ninguno"], correctPrize: "Premio Nobel de Literatura" }, unlocked: false },
            
            { id: 2, title: "Romancero Gitano", author: "Federico García Lorca", year: 1928, image: "imagenportada/romancero.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1gjwNaLyF9pcyDi3hAnp8mC242AOSisWH/view?usp=drive_link", description: "La pasión flamenca de Lorca convertida en una experiencia musical única e inolvidable. Poema: Romance de la luna, luna", comments: [], lyrics: `La luna vino a la fragua
            con su polisón de nardos.
            El niño la mira mira.
            El niño la está mirando.
            
            En el aire conmovido
            mueve la luna sus brazos
            y enseña, lúbrica y pura,
            sus senos de duro estaño.`, quizData: { author: "Federico García Lorca", title: "Romancero Gitano", prizes: ["Premio Príncipe de Asturias", "Ninguno", "Premio Pulitzer"], correctPrize: "Ninguno" }, unlocked: false },
            
            { id: 3, title: "Canción del Pirata", author: "José de Espronceda", year: 1840, image: "imagenportada/cancionpirata.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1FESYoCEEVHec7pt8qHd9TBGVx0HGMoor/view?usp=drive_link", description: "La libertad y aventura del romanticismo español en una composición musical épica.", comments: [], lyrics: `Con diez cañones por banda,
            viento en popa, a toda vela,
            no corta el mar, sino vuela,
            un velero bergantín.
            
            Bajel pirata que llaman
            por su bravura el Temido,
            en todo mar conocido
            del uno al otro confín.`, quizData: { author: "José de Espronceda", title: "Canción del Pirata", prizes: ["Premio Nacional de Literatura", "Ninguno", "Premio Goya"], correctPrize: "Ninguno" }, unlocked: false },
            
            { id: 4, title: "Campos de Castilla", author: "Antonio Machado", year: 1912, image: "imagenportada/campos.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/17wJUWWeQXcOiGreNjGRvhu46dlrDUAVH/view?usp=drive_link", description: "Los paisajes castellanos de Machado cobran vida en una melodía contemplativa y profunda.", comments: [], lyrics: `El limonar, florido yema,
            sobre el muro tan agrio,
            la fuente de piedra,
            el camino blanco y seco,
            la montaña azul y vieja,
            la tierra parda y yerma.`, quizData: { author: "Antonio Machado", title: "Campos de Castilla", prizes: ["Premio Nobel de Literatura", "Ninguno", "Premio Cervantes"], correctPrize: "Ninguno" }, unlocked: false },
            
            { id: 5, title: "Altazor", author: "Vicente Huidobro", year: 1931, image: "imagenportada/altazor.png", totalStars: 0, youtubeUrl: "https://youtu.be/Nqo1WXHvjoI?si=TDlmUXkYpwq-Xcrq", driveUrl: "https://drive.google.com/file/d/1AcgtWTs8pOFsdRBvKBHisPX_HkXw2ORK/view?usp=drive_link", description: "La vanguardia poética transformada en una experiencia sonora experimental y revolucionaria.", comments: [], lyrics: `No hay tiempo que perder.
            Vamos a la luna o al sol,
            o donde sea,
            donde las manos puedan cortar
            la vida del instante
            que se abre en las manos del hombre.`, quizData: { author: "Vicente Huidobro", title: "Altazor o el viaje en paracaídas", prizes: ["Premio Nacional de Literatura de Chile", "Ninguno", "Premio Cervantes"], correctPrize: "Premio Nacional de Literatura de Chile" }, unlocked: false },
            
            { id: 6, title: "Trilce", author: "César Vallejo", year: 1922, image: "imagenportada/trilce.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1ArrRC6iAOXmFBsJUw5gMCRWfHLD_MIwx/view?usp=drive_link", description: "La innovación lingüística de Vallejo encuentra su expresión en armonías sorprendentes.", comments: [], lyrics: `Quién hace tanta bulla y ni deja
            testar las únicas herencias.
            Y quien de una simple trenza
            hace toda una madeja.
            
            Día y noche, día y noche
            sin darnos un respiro, un desvelo.
            El hambre en el vientre del cielo.`, quizData: { author: "César Vallejo", title: "Trilce", prizes: ["Premio Cervantes", "Ninguno", "Premio Rómulo Gallegos"], correctPrize: "Ninguno" }, unlocked: false },
            
            { id: 7, title: "La Voz a Ti Debida", author: "Pedro Salinas", year: 1933, image: "imagenportada/lavoz.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/17dRJL2X7fq5rlRn6ho-KsSETGs5Qkeb2/view?usp=drive_link", description: "El amor puro de Salinas convertido en una balada contemporánea llena de sentimiento.", comments: [], lyrics: `Tú vives siempre en tus actos.
            Con la muerte, el telón
            bajo el cual la vida.
            Si, pero es una vida sin ti,
            sin el que tú eras.
            Es la vida en su forma
            más triste, su forma
            de recuerdo.`, quizData: { author: "Pedro Salinas", title: "La Voz a Ti Debida", prizes: ["Premio Nacional de Literatura", "Premio Príncipe de Asturias", "Ninguno"], correctPrize: "Ninguno" }, unlocked: false },
            
            { id: 8, title: "Residencia en la Tierra", author: "Pablo Neruda", year: 1935, image: "imagenportada/residencia.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1NtevvMlrWrlanbsIpIEpZYpf2fHNdfNC/view?usp=drive_link", description: "La angustia existencial nerudiana transmutada en composiciones oscuras y evocadoras.", comments: [], lyrics: `Barcarola.
            Si solamente me dieras
            la noche, la noche oscura.
            Y si solamente dieras
            el mar con sus olas furiosas,
            yo sería feliz.
            
            Pero me das la luz,
            la luna y el sol,
            y el tiempo.`, quizData: { author: "Pablo Neruda", title: "Residencia en la Tierra", prizes: ["Premio Nobel de Literatura", "Premio Cervantes", "Ninguno"], correctPrize: "Premio Nobel de Literatura" }, unlocked: false },
            
            { id: 9, title: "Poeta en Nueva York (Vuelta de paseo)", author: "Federico García Lorca", year: 1940, image: "imagenportada/aurora.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1-9_6Om33P7uIMcHgNWYgws2zmHUeuqKB/view?usp=drive_link", description: "El surrealismo urbano de Lorca en la gran manzana, ahora en ritmos modernos.", comments: [], lyrics: `Asesinado por el cielo,
            entre las formas que van hacia la sierpe
            y las formas que buscan el cristal.
            
            Dejaré crecer mis cabellos.
            Dejaré crecer mis uñas.
            Iré al mar con el traje roto,
            y el corazón destrozado.`, quizData: { author: "Federico García Lorca", title: "Poeta en Nueva York", prizes: ["Premio Nobel de Literatura", "Ninguno", "Premio Príncipe de Asturias"], correctPrize: "Ninguno" }, unlocked: false },
            
            { id: 10, title: "Marinero en Tierra", author: "Rafael Alberti", year: 1925, image: "imagenportada/marinero.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1RoOZ6YiILZbmaQWX2-_4FGE_fuKyW1xB/view?usp=drive_link", description: "La nostalgia marinera de Alberti navega en melodías que evocan el Mediterráneo.", comments: [], lyrics: `Yo, marinero, en la ribera mía,
            navegando sin mar y sin navío.
            Caminando sobre el sol y el frío
            de la sed y el recuerdo.
            
            Daría por el mar de la mañana
            la orilla de la tierra.
            Daría por la sombra de una barca
            esta llanura yerma.`, quizData: { author: "Rafael Alberti", title: "Marinero en Tierra", prizes: ["Premio Cervantes", "Premio Príncipe de Asturias", "Ninguno"], correctPrize: "Premio Cervantes" }, unlocked: false }
        ];

        var songs = []; 
        var votesRemaining = 5; // NUEVO: Límite de 5 votos
        var userStars = 0; // NUEVO: Moneda del usuario (acumuladas del Quiz)
        var totalStarsCount = 0; // Total de estrellas acumuladas por TODAS las canciones
        var selectedSongId = null; // ID de la canción para Quiz o votación
        var lastUpdateDate = null; 
        
        // DATA: COMENTARIOS GLOBALES
        var globalComments = [];
        
        // --- LOCAL STORAGE FUNCTIONS ---
        function saveAppData() {
            localStorage.setItem('literatura_songs', JSON.stringify(songs));
            localStorage.setItem('literatura_votesRemaining', votesRemaining); // Guardar votos restantes
            localStorage.setItem('literatura_lastUpdateDate', lastUpdateDate ? lastUpdateDate.toISOString() : null);
            localStorage.setItem('literatura_userStars', userStars); // Guardar estrellas del usuario (moneda)
            localStorage.setItem('literatura_globalComments', JSON.stringify(globalComments)); 
            localStorage.setItem('literatura_totalStars', totalStarsCount); // Guardar totalStarsCount de las canciones
        }

        function loadAppData() {
            const savedSongs = localStorage.getItem('literatura_songs');
            const savedVotes = localStorage.getItem('literatura_votesRemaining'); // Cargar votos restantes
            const savedDate = localStorage.getItem('literatura_lastUpdateDate');
            const savedUserStars = localStorage.getItem('literatura_userStars'); // Cargar estrellas del usuario
            const savedGlobalComments = localStorage.getItem('literatura_globalComments');
            const savedTotalStars = localStorage.getItem('literatura_totalStars'); 

            songs = savedSongs ? JSON.parse(savedSongs) : initialSongs;
            votesRemaining = savedVotes !== null && !isNaN(parseInt(savedVotes)) ? parseInt(savedVotes) : 5; 
            userStars = savedUserStars !== null && !isNaN(parseInt(savedUserStars)) ? parseInt(savedUserStars) : 0; // Inicializar userStars
            globalComments = savedGlobalComments ? JSON.parse(savedGlobalComments) : []; 
            totalStarsCount = savedTotalStars !== null && !isNaN(parseInt(savedTotalStars)) ? parseInt(savedTotalStars) : 0; 
            
            lastUpdateDate = savedDate && savedDate !== 'null' ? new Date(savedDate) : new Date();

            // Mapeo y saneamiento de datos al cargar (INCLUYE MIGRACION DE totalVotes a totalStars)
            songs = songs.map(song => {
                if (!song.comments) song.comments = [];
                
                // MIGRACION: totalVotes a totalStars
                if (typeof song.totalStars === 'undefined') { 
                    if (typeof song.totalVotes !== 'undefined') { 
                        song.totalStars = song.totalVotes;
                        delete song.totalVotes; 
                    } else {
                        song.totalStars = 0;
                    }
                }
                
                if (typeof song.unlocked === 'undefined') {
                    const initialSong = initialSongs.find(s => s.id === song.id);
                    song.unlocked = initialSong ? initialSong.unlocked : false;
                }
                 // Sincronizar quizData
                const initialSong = initialSongs.find(s => s.id === song.id);
                if (initialSong) {
                     song.quizData = initialSong.quizData;
                }
                return song;
            });
            
            // Si el array de canciones guardado es más corto que el inicial
            if (songs.length < initialSongs.length) {
                const existingIds = new Set(songs.map(s => s.id));
                initialSongs.forEach(newSong => {
                    if (!existingIds.has(newSong.id)) {
                        songs.push(newSong);
                    }
                });
            }
            
            // Recalcular totalStarsCount (solo si es necesario, para asegurar)
            if (totalStarsCount === 0 && songs.some(s => s.totalStars > 0)) {
                totalStarsCount = songs.reduce((sum, song) => sum + (song.totalStars || 0), 0);
            }
            
            // Actualizar la cabecera
            document.getElementById('votesRemainingDisplay').textContent = votesRemaining;
            document.getElementById('userStarsDisplay').textContent = userStars; 
        }

        // --- FUNCIONES DEL MENÚ DE PERFIL ---
        function toggleProfileDropdown() {
            document.getElementById('profileDropdown').classList.toggle('hidden');
        }

        // --- FUNCIONES DE COMENTARIOS GLOBALES ---
        
        function addGlobalComment() {
            var globalCommentInput = document.getElementById('globalCommentInput');
            var text = globalCommentInput.value.trim();
            if (text === "") return;

            var newComment = {
                text: text,
                timestamp: new Date().toLocaleString(),
                user: "Usuario Anónimo" 
            };

            globalComments.unshift(newComment); 
            globalCommentInput.value = '';
            saveAppData();
            renderGlobalComments(); 
        }
        
        function renderGlobalComments() {
            var globalCommentsContainer = document.getElementById('globalCommentsContainer');
            if (!globalCommentsContainer) return;

            if (globalComments.length === 0) {
                 globalCommentsContainer.innerHTML = '<p class="text-center text-gray-500 italic" id="noGlobalCommentsMessage">No hay comentarios aún. ¡Sé el primero en comentar!</p>';
                 return;
            }

            var globalCommentsHtml = globalComments.map(comment => {
                const userName = comment.user || 'Usuario Anónimo'; 
                return '<div class="bg-indigo-700/50 p-3 rounded-lg border border-indigo-500"><p class="text-xs font-semibold text-yellow-300">' + userName + ' (' + comment.timestamp + ')</p><p class="text-base">' + comment.text + '</p></div>';
            }).join('');
            
            globalCommentsContainer.innerHTML = globalCommentsHtml;
        }
        
        // --- FUNCIONES DE MODALES ---

        function openGlobalInfoModal() {
            document.getElementById('globalInfoModal').classList.remove('hidden');
            renderGlobalComments(); // Asegura que los comentarios se carguen al abrir el modal
        }

        function closeGlobalInfoModal() {
            document.getElementById('globalInfoModal').classList.add('hidden');
        }
        
        function closeInfoModal() {
            document.getElementById('infoModal').classList.add('hidden');
            selectedSongId = null;
        }
        
        function openMissionModal() {
            document.getElementById('profileDropdown').classList.add('hidden');
            document.getElementById('missionModal').classList.remove('hidden');
        }

        function closeMissionModal() {
            document.getElementById('missionModal').classList.add('hidden');
        }
        
        function closeVoteSelectionModal() {
            document.getElementById('voteSelectionModal').classList.add('hidden');
            selectedSongId = null;
        }
        
        function logout() {
            alert("Has cerrado sesión. Redireccionando...");
        }

        // --- FUNCIONES DEL RANKING Y VOTOS ---

        function checkAndResetWeeklyData() {
            var today = new Date();
            
            // Comprobación simple de si ha pasado una semana (7 días)
            if (!lastUpdateDate || (today.getTime() - lastUpdateDate.getTime()) > (7 * 24 * 60 * 60 * 1000)) {
                votesRemaining = 5; // Reinicia el límite de 5 votos
                lastUpdateDate = today;
                document.getElementById('votesRemainingDisplay').textContent = votesRemaining;
                saveAppData();
                return;
            }
        }
        
        /**
         * NUEVA FUNCIÓN: Muestra el modal para que el usuario elija la cantidad de estrellas a votar.
         */
        function openVoteSelectionModal(songId) {
            if (votesRemaining <= 0) {
                alert("Has alcanzado el límite de 5 votos por semana. Vuelve la próxima semana.");
                return;
            }
            
            selectedSongId = songId;
            document.getElementById('userStarsInModal').textContent = userStars;
            const optionsContainer = document.getElementById('voteOptionsContainer');
            optionsContainer.innerHTML = '';
            
            const starOptions = [5, 6, 7, 8, 9, 10];
            
            // Icono de estrella simplificado para el botón del modal de votación
            const miniStarSvg = '<svg class="w-4 h-4 text-yellow-900 fill-current" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>';
            
            starOptions.forEach(stars => {
                const button = document.createElement('button');
                // MODIFICACIÓN: Borra la palabra "Estrellas" y deja el icono en el botón de selección de voto
                button.innerHTML = `${stars} ${miniStarSvg}`;
                button.classList.add('py-2', 'rounded-lg', 'font-bold', 'transition-all', 'flex', 'items-center', 'justify-center', 'gap-1');
                
                // RESTRICCIÓN CLAVE: Deshabilitar si no tiene suficientes estrellas
                if (stars > userStars) {
                    button.disabled = true;
                    button.title = `Necesitas ${stars} estrellas. Tienes ${userStars}.`;
                    button.classList.add('bg-gray-600', 'text-gray-400', 'cursor-not-allowed', 'opacity-50');
                } else {
                    button.onclick = () => castStarVote(songId, stars);
                    button.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900', 'hover:scale-110');
                }
                
                optionsContainer.appendChild(button);
            });
            
            document.getElementById('voteSelectionModal').classList.remove('hidden');
        }

        /**
         * NUEVA FUNCIÓN: Emite el voto, gasta las estrellas y resta un voto.
         */
        function castStarVote(songId, starCost) {
            // Re-chequeo de seguridad
            if (votesRemaining <= 0) {
                alert("No te quedan votos.");
                return;
            }

            if (starCost > userStars) {
                alert("Error: No tienes suficientes estrellas para este voto.");
                return;
            }
            
            var song = songs.find(s => s.id === songId);
            if (!song) return;
            
            // 1. Deducir las estrellas del usuario (Gasto)
            userStars -= starCost; 
            
            // 2. Deducir el límite de votos
            votesRemaining--; 
            
            // 3. Sumar las estrellas a la canción (Acumulación)
            song.totalStars = (song.totalStars || 0) + starCost; 
            totalStarsCount += starCost; 
            
            // 4. Guardar y actualizar
            saveAppData();
            updateHeaderDisplay();
            closeVoteSelectionModal();
            renderSongs();
            
            alert(`¡Voto registrado! Has gastado ${starCost} estrellas. La canción "${song.unlocked ? song.title : 'Obra Misteriosa'}" ha ganado ${starCost} estrellas. Te quedan ${votesRemaining} votos y ${userStars} estrellas.`);
        }

        function updateHeaderDisplay() {
            document.getElementById('votesRemainingDisplay').textContent = votesRemaining;
            document.getElementById('userStarsDisplay').textContent = userStars;
            // No hay necesidad de totalStarsCount en el header, pero lo mantenemos en el modelo de datos.
        }

        function renderSongs() {
            var sortedSongs = songs.slice().sort((a, b) => (b.totalStars || 0) - (a.totalStars || 0)); // Ordenar por totalStars
            
            var top3 = sortedSongs.slice(0, 3);
            var top3Container = document.getElementById('top3Container');
            var top3Html = '';
            
            const audioSvg = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>';
            
            // Icono de estrella que reemplaza el texto "Estrellas" y se usa en el botón VOTAR
            const starSvg = '<svg class="w-5 h-5 text-yellow-300 fill-current ml-1" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>';
            
            for (var i = 0; i < top3.length; i++) {
                var song = top3[i];
                // Los botones de voto ya no se generan aquí, se genera el botón para abrir el modal
                
                const titleDisplay = song.unlocked ? song.title : "Obra Literaria Misteriosa";
                const infoDisplay = song.unlocked ? `Autor: ${song.author}, Año: ${song.year}` : "Autor y Año ocultos hasta completar el Quiz.";
                const imageTag = '<img src="' + song.image + '" alt="Portada de la obra ' + song.title + '" class="w-full h-48 rounded-lg mb-4 cursor-pointer hover:scale-105 transition-transform object-cover" onclick="openQuizModal(' + song.id + ')">';
                
                // MODIFICACIÓN 1.1 (TOP 3): Elimina la palabra "Estrellas" y añade el icono SVG
                const starsTop3 = '<span class="flex items-center text-xl font-bold text-yellow-300">' + '⭐'.repeat(Math.floor((song.totalStars || 0) / 10)) + ` (${song.totalStars || 0})` + starSvg + '</span>';

                top3Html += '<div class="relative group"><div class="absolute -inset-1 bg-gradient-to-r from-yellow-400 via-orange-400 to-red-400 rounded-2xl blur opacity-75 group-hover:opacity-100 transition duration-300"></div><div class="relative bg-gradient-to-br from-cyan-900 to-teal-900 rounded-2xl p-6 border-2 border-yellow-400">' +
                    '<div class="absolute -top-4 -left-4 bg-yellow-400 text-gray-900 w-12 h-12 rounded-full flex items-center justify-center text-2xl font-bold shadow-lg">' + (i + 1) + '</div>' + imageTag + 
                    '<h3 class="text-xl font-bold mb-2 text-yellow-500">' + titleDisplay + '</h3>' +
                    '<p class="text-cyan-200 mb-2 font-light">' + infoDisplay + '</p>' + 
                    // Se usa la variable starsTop3 modificada
                    '<div class="flex items-center justify-between mb-4">' + starsTop3 + '</div><div class="space-y-2">' +
                    '<button onclick="openQuizModal(' + song.id + ')" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3 rounded-lg font-bold transition-all hover:scale-105 flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 002-2h2a2 2 0 002 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>' + (song.unlocked ? 'VER INFO' : 'HACER QUIZZ') + '</button>' +
                    // MODIFICACIÓN 1.2 (BOTÓN VOTAR TOP 3): Elimina las palabras "con estrellas" o similar y deja el icono
                    '<button onclick="openVoteSelectionModal(' + song.id + ')" ' + (votesRemaining <= 0 ? 'disabled' : '') + ' class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 disabled:from-gray-600 disabled:to-gray-700 py-3 rounded-lg font-bold transition-all hover:scale-105 disabled:scale-100 disabled:cursor-not-allowed flex items-center justify-center gap-1">VOTAR' + starSvg + '</button>' +
                    '<button onclick="openDriveApp(\'' + song.driveUrl + '\')" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 py-3 rounded-lg font-bold transition-all hover:scale-105 flex items-center justify-center gap-2">' + audioSvg + ' Audio</button>' +
                    '</div></div></div></div>';
            }
            top3Container.innerHTML = top3Html;
            
            var ranking = sortedSongs.slice(3);
            var rankingContainer = document.getElementById('rankingContainer');
            var rankingHtml = '';
            
            // Icono de estrella para el ranking (más pequeño)
            const starSvgSmall = '<svg class="w-4 h-4 text-yellow-300 fill-current ml-1" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>';
            
            for (var i = 0; i < ranking.length; i++) {
                var song = ranking[i];
                
                const titleDisplay = song.unlocked ? song.title : "Obra Misteriosa";
                const infoDisplay = song.unlocked ? `${song.author} (${song.year})` : "Autor/Año ocultos";
                const imageTagSmall = '<img src="' + song.image + '" alt="Portada de la obra ' + song.title + '" class="w-24 h-24 rounded-lg cursor-pointer hover:scale-110 transition-transform object-cover" onclick="openQuizModal(' + song.id + ')">';
                
                // MODIFICACIÓN 2.1 (RANKING): Elimina la palabra "Estrellas" y añade el icono SVG
                const starsRanking = '<span class="flex items-center text-lg font-bold text-yellow-300">' + '⭐'.repeat(Math.floor((song.totalStars || 0) / 10)) + ` (${song.totalStars || 0})` + starSvgSmall + '</span>';
                
                rankingHtml += '<div class="bg-cyan-800/40 backdrop-blur-sm rounded-xl p-4 border border-cyan-600/50 hover:border-cyan-400 transition-all hover:scale-105"><div class="flex items-start gap-4">' +
                    '<div class="flex-shrink-0"><div class="bg-teal-600 text-white w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold">' + (i + 4) + '</div></div>' +
                    imageTagSmall +
                    '<div class="flex-grow">' +
                    '<h3 class="text-lg font-bold mb-1 text-yellow-500">' + titleDisplay + '</h3>' +
                    '<p class="text-cyan-200 text-sm mb-2 font-light">' + infoDisplay + '</p>' +
                    // Se usa la variable starsRanking modificada
                    '<p class="text-lg font-bold text-yellow-300 mb-2">' + starsRanking + '</p><div class="space-y-2">' +
                    '<button onclick="openQuizModal(' + song.id + ')" class="w-full bg-indigo-600 hover:bg-indigo-700 py-2 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 002-2h2a2 2 0 002 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>' + (song.unlocked ? 'VER INFO' : 'QUIZZ') + '</button>' +
                    // MODIFICACIÓN 2.2 (BOTÓN VOTAR RANKING): Elimina las palabras "con estrellas" o similar y deja el icono
                    '<button onclick="openVoteSelectionModal(' + song.id + ')" ' + (votesRemaining <= 0 ? 'disabled' : '') + ' class="w-full bg-emerald-600 hover:bg-emerald-700 disabled:bg-gray-600 py-2 rounded-lg text-sm font-bold transition-all disabled:cursor-not-allowed flex items-center justify-center gap-1">VOTAR' + starSvgSmall + '</button>' +
                    '<button onclick="openDriveApp(\'' + song.driveUrl + '\')" class="w-full bg-purple-600 hover:bg-purple-700 py-2 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-1">' + audioSvg + ' Audio</button>' + 
                    '</div></div></div></div>';
            }
            rankingContainer.innerHTML = rankingHtml;
        }

        function showInfo(songId) {
            // Lógica para mostrar la info detallada (desbloqueada)
            selectedSongId = songId;
            var song = songs.find(s => s.id === songId);
            if (!song || !song.unlocked) {
                // Esta verificación es redundante si se llama solo desde openQuizModal, pero se mantiene por seguridad
                alert("Debes completar el Quiz para desbloquear la información detallada.");
                return;
            }
            
            var infoContent = document.getElementById('infoContent');
            
            // COMENTARIOS ESPECÍFICOS DE LA CANCIÓN
            var songCommentsHtml = song.comments.map(comment => {
                return '<div class="bg-cyan-700/50 p-3 rounded-lg border border-cyan-500"><p class="text-sm font-light text-cyan-200 mb-1">Usuario Anónimo (' + comment.timestamp + ')</p><p>' + comment.text + '</p></div>';
            }).join('');
            
            
            const youtubeSvg = '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.613-.264-7.525-.373-11.614 0C2.924 3.42 2.05 4.364 2 5.485v13.03c.05.992.934 1.936 5.001 2.217 4.088.264 7.999.373 11.614 0 4.075-.28 4.962-1.224 5.001-2.217V5.485c-.039-1.121-.925-2.065-5.001-2.217zM10 16.5v-9l6 4.5-6 4.5z"/></svg>'; 
            const driveSvg = '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm-2.5 15.5l-5-5c-.375-.375-.375-.98 0-1.354l5-5c.375-.375.98-.375 1.354 0l5 5c.375.375.375.98 0 1.354l-5 5c-.375.375-.98.375-1.354 0zM12 8.646L13.707 10.354l-1.707 1.707L10.293 10.354l1.707-1.707z"/></svg>'; 
            // REEMPLAZO DEL PLACEHOLDER POR IMAGEN REAL (Modal Info)
            const imageTagLarge = '<img src="' + song.image + '" alt="Portada de la obra ' + song.title + '" class="w-full h-64 rounded-lg mb-6 object-cover">';

            var infoContentHtml = imageTagLarge +
            '<h3 class="text-3xl font-bold mb-3">' + song.title + '</h3><p class="text-xl text-cyan-200 mb-2">Autor: ' + song.author + '</p><p class="text-lg text-cyan-300 mb-4">Año: ' + song.year + '</p><p class="text-lg mb-6 leading-relaxed">' + song.description + '</p><div class="flex flex-col md:flex-row gap-4 mb-6"><button onclick="openLyricsModal(' + song.id + ')" class="flex-1 bg-yellow-600 hover:bg-yellow-700 px-6 py-3 rounded-lg font-bold transition-all hover:scale-105 flex items-center justify-center gap-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>Letra</button>' + 
            '<button onclick="openYoutubeApp(\'' + song.youtubeUrl + '\')" class="flex-1 bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-bold transition-all hover:scale-105 flex items-center justify-center gap-2">' + youtubeSvg + ' Abrir en YouTube</button>' +
            '<button onclick="openDriveApp(\'' + song.driveUrl + '\')" class="flex-1 bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-bold transition-all hover:scale-105 flex items-center justify-center gap-2">' + driveSvg + ' Abrir en Drive</button></div>' +
            
            // SECCIÓN DE COMENTARIOS ESPECÍFICOS DE LA CANCIÓN
            '<div class="border-t border-cyan-600 pt-6 mt-6"><h4 class="text-xl font-bold mb-4 flex items-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>Comentarios de la Obra (' + song.comments.length + ')</h4><div class="mb-4"><textarea id="commentInput" placeholder="Escribe tu comentario sobre ' + song.title + '..." class="w-full bg-cyan-800/50 border border-cyan-600 rounded-lg p-3 text-white placeholder-cyan-400 focus:outline-none focus:border-cyan-400" rows="3"></textarea><button onclick="addComment()" class="mt-2 bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg font-bold transition">Añadir Comentario</button></div><div id="commentsContainer" class="space-y-3">' + (song.comments.length > 0 ? songCommentsHtml : '<p class="text-center text-gray-500 italic">No hay comentarios aún. Sé el primero en comentar.</p>') + '</div></div>';
            
            infoContent.innerHTML = infoContentHtml;
            
            document.getElementById('infoModal').classList.remove('hidden');
        }

        // --- FUNCIONES DEL QUIZ ---

        function openQuizModal(songId) {
            selectedSongId = songId;
            var song = songs.find(s => s.id === songId);

            if (!song) return;

            // 1. Si la info está desbloqueada, se muestra directamente la información detallada (sin Quiz)
            if (song.unlocked) {
                showInfo(songId);
                return;
            }
            
            // 2. Prepara el contenido del Quiz para la obra OCULTA
            document.getElementById('quizTitle').textContent = `Quiz para Desbloquear la Obra`;
            
            var quizContent = document.getElementById('quizContent');
            var quizData = song.quizData;
            
            // Creación de opciones de respuesta (simuladas, pero solo la correcta es relevante para el check)
            const authorOptions = [quizData.author, "Gabriel García Márquez", "Jorge Luis Borges"].sort(() => Math.random() - 0.5);
            const titleOptions = [quizData.title, "Cien Años de Soledad", "Rayuela"].sort(() => Math.random() - 0.5);
            const prizeOptions = quizData.prizes.sort(() => Math.random() - 0.5);
            
            const generateSelect = (id, label, options, correctValue) => {
                let optionsHtml = options.map(opt => `<option value="${opt.toLowerCase().replace(/[^\w\s]/gi, '').replace(/\s/g, '')}">${opt}</option>`).join('');
                return `<div class="mb-4 p-4 bg-indigo-800 rounded-lg border border-indigo-700">
                            <label for="${id}" class="block text-yellow-300 font-bold mb-2">${label}</label>
                            <select id="${id}" required class="w-full p-3 bg-indigo-900/50 rounded-lg text-white border border-indigo-600 focus:outline-none focus:border-red-400">
                                <option value="" disabled selected>Selecciona una opción</option>
                                ${optionsHtml}
                            </select>
                            <input type="hidden" id="${id}CorrectValue" value="${correctValue.toLowerCase().replace(/[^\w\s]/gi, '').replace(/\s/g, '')}">
                        </div>`;
            };

            var quizHtml = `
                <p class="text-lg text-gray-300">¡Acertando **1 o más preguntas**, desbloquearás la información! Gana **5 estrellas** por acierto, acumulables en tu saldo.</p>
                <form id="quizForm" onsubmit="submitQuiz(event)">
                    <input type="hidden" id="quizSongId" value="${songId}">
                    
                    ${generateSelect('answerAuthor', '1. ¿Quién es el autor de esta obra?', authorOptions, quizData.author)}
                    ${generateSelect('answerTitle', '2. ¿Cuál es el título original de la obra o libro?', titleOptions, quizData.title)}
                    ${generateSelect('answerPrize', '3. ¿Obtuvo alguno de estos premios?', prizeOptions, quizData.correctPrize)}
                    
                    <button type="submit" class="w-full bg-red-600 hover:bg-red-700 py-3 mt-4 rounded-lg font-bold transition-all hover:scale-105 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Enviar Respuestas y Desbloquear
                    </button>
                </form>
            `;
            
            quizContent.innerHTML = quizHtml;
            document.getElementById('quizModal').classList.remove('hidden');
        }

        function submitQuiz(event) {
            event.preventDefault();

            const songId = parseInt(document.getElementById('quizSongId').value);
            const song = songs.find(s => s.id === songId);

            if (!song) {
                 alert("Error de canción.");
                 return;
            }

            const getAnswer = (id) => document.getElementById(id).value.toLowerCase().replace(/[^\w\s]/gi, '').replace(/\s/g, '');
            const getCorrect = (id) => document.getElementById(id + 'CorrectValue').value;

            const answerAuthor = getAnswer('answerAuthor');
            const answerTitle = getAnswer('answerTitle');
            const answerPrize = getAnswer('answerPrize');

            const isAuthorCorrect = answerAuthor === getCorrect('answerAuthor');
            const isTitleCorrect = answerTitle === getCorrect('answerTitle');
            const isPrizeCorrect = answerPrize === getCorrect('answerPrize');
            
            let correctCount = (isAuthorCorrect ? 1 : 0) + (isTitleCorrect ? 1 : 0) + (isPrizeCorrect ? 1 : 0);
            
            let resultMessage = `¡Quiz completado! Acertaste ${correctCount} de 3 preguntas.\n`;
            
            // Check for unlocking condition (1 or more correct is enough)
            if (correctCount >= 1) {
                song.unlocked = true;
                
                // SCORING RULE 1: 5 estrellas por cada pregunta acertada (se acumulan en el usuario)
                let starsAwarded = correctCount * 5;
                
                // SCORING RULE 2: 10 estrellas de bonificación por 3/3 (se acumulan en el usuario)
                if (correctCount === 3) {
                    starsAwarded += 10;
                    resultMessage += `\n¡BONUS! Conseguiste 3/3, por lo que ganas 10 estrellas extra de bonificación.`;
                } 
                
                // Acumular al saldo del usuario
                userStars += starsAwarded;
                
                saveAppData();
                updateHeaderDisplay(); // Actualiza el nuevo contador de estrellas
                closeQuizModal();
                renderSongs(); 
                
                resultMessage += `Has ganado ${starsAwarded} estrellas para gastar en votos.\nLa información de la obra ha sido desbloqueada.`;

                alert(resultMessage);
                showInfo(songId); // Muestra inmediatamente la información detallada
            } else {
                alert("Inténtalo de nuevo. La información solo se desbloquea con al menos 1 acierto. No has ganado estrellas.");
            }
        }

        function closeQuizModal() {
            document.getElementById('quizModal').classList.add('hidden');
            selectedSongId = null;
        }
        
        // --- FUNCIONES DEL MODAL DE LETRAS ---
        function openLyricsModal(songId) {
            const song = songs.find(s => s.id === songId);
            if (!song) return;

            document.getElementById('lyricsTitle').textContent = `Letra de: ${song.title}`;
            document.getElementById('lyricsContent').textContent = song.lyrics;
            document.getElementById('lyricsModal').classList.remove('hidden');
        }

        function closeLyricsModal() {
            document.getElementById('lyricsModal').classList.add('hidden');
        }
        
        // --- OTRAS FUNCIONES AUXILIARES ---

        function openDriveApp(url) {
            window.open(url, '_blank');
        }
        
        function openYoutubeApp(url) {
            window.open(url, '_blank');
        }
        
        function addComment() {
            // Lógica de añadir comentarios a la canción específica
            var commentInput = document.getElementById('commentInput');
            var text = commentInput.value.trim();
            if (text === "") return;

            var song = songs.find(s => s.id === selectedSongId);
            if (!song) return;
            
            var newComment = {
                text: text,
                timestamp: new Date().toLocaleString()
            };

            song.comments.unshift(newComment); 
            commentInput.value = '';
            saveAppData();
            showInfo(selectedSongId); 
        }

        // --- INICIALIZACIÓN ---
        function init() {
            loadAppData(); 
            checkAndResetWeeklyData(); 
            // Recalcular totalStarsCount al inicio si no se hizo en loadAppData para asegurar exactitud
            totalStarsCount = songs.reduce((sum, song) => sum + (song.totalStars || 0), 0);
            updateHeaderDisplay(); 
            saveAppData(); 
            renderSongs();
        }
        
        // Cierre de modales al clickear fuera
        document.getElementById('infoModal').addEventListener('click', function(e) {
            if (e.target === this) closeInfoModal();
        });

        document.getElementById('lyricsModal').addEventListener('click', function(e) {
            if (e.target === this) closeLyricsModal(); 
        });

        document.getElementById('quizModal').addEventListener('click', function(e) {
            if (e.target === this) closeQuizModal(); 
        });
        
        document.getElementById('globalInfoModal').addEventListener('click', function(e) {
            if (e.target === this) closeGlobalInfoModal(); 
        });
        
        document.getElementById('missionModal').addEventListener('click', function(e) {
            if (e.target === this) closeMissionModal(); 
        });
        
        document.getElementById('voteSelectionModal').addEventListener('click', function(e) {
            if (e.target === this) closeVoteSelectionModal(); 
        });
        
        // Cierra el menú desplegable si se hace click fuera
        document.addEventListener('click', function(e) {
            const profileDropdown = document.getElementById('profileDropdown');
            const profileMenuContainer = document.getElementById('profileMenuContainer');
            
            if (profileDropdown && !profileMenuContainer.contains(e.target) && !profileDropdown.classList.contains('hidden')) {
                profileDropdown.classList.add('hidden');
            }
        });


        // Ejecutar la inicialización al cargar la página
        window.onload = init;
    </script>
</body>
</html>