<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala 1 - Versión Unificada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Animaciones Personalizadas */
        @keyframes pulse-custom {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.3; }
        }
        @keyframes bounce-custom {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes blink-custom {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-custom { animation: pulse-custom 3s ease-in-out infinite; }
        .animate-bounce-custom { animation: bounce-custom 2s ease-in-out infinite; }
        .animate-blink-custom { animation: blink-custom 1s step-start infinite; }

        /* Animación para la nota junto al título */
        @keyframes bounce-sala1 {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); } /* Movimiento de 5px hacia arriba y abajo */
        }

        .animate-bounce-sala1 {
            animation: bounce-sala1 1.5s ease-in-out infinite;
        }

        .hidden { display: none; }
        
        /* Estilo para el reproductor de audio (DEPRECADO, pero mantenido para consistencia si se usa en otro lado) */
        audio::-webkit-media-controls-panel {
            background-color: #312e81; /* Indigo-800 */
            color: white;
        }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-mute-button {
            color: #fcd34d; /* Yellow-400 */
        }

        /* Animación para el icono flotante (DEPRECADO, se mantiene el código base de float) */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); } 
            100% { transform: translateY(0px); }
        }

        .animate-float {
            animation: float 2.5s ease-in-out infinite; 
        }
        
        .image-placeholder {
            /* Estilo para simular que la imagen carga */
            background-color: #1f2937; /* Gray-800 */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4b5563; /* Gray-500 */
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans">
    
   <header class="bg-indigo-950 p-4 shadow-xl sticky top-0 z-10 border-b border-indigo-800">
    <div class="container mx-auto flex flex-col items-center">
        
        <h1 class="text-xl md:text-3xl font-extrabold text-teal-400 flex items-center justify-center w-full mb-2">
            <svg class="w-6 h-6 md:w-8 md:h-8 mr-2 text-yellow-400 animate-bounce-sala1" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-8z"/>
            </svg>
            Sala 1
        </h1>
        
        <div class="w-full flex justify-between items-center mb-2 md:mb-4">
            
             <div class="flex items-center space-x-4 text-sm md:text-lg">
                <span class="text-cyan-400">Votos Restantes: <span id="votesRemainingDisplay" class="font-bold text-yellow-400">5</span></span>
                <span class="text-cyan-400 hidden sm:inline-block">|</span>
                <span class="text-cyan-400">Estrellas Acumuladas:<span id="userStarsDisplay" class="font-bold text-yellow-400">0</span></span>
             </div>
             
             <div class="flex items-center space-x-2 md:space-x-4">
                <button onclick="openGlobalInfoModal()" class="bg-indigo-700 hover:bg-indigo-600 p-2 rounded-full transition-all hover:scale-105">
                    <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </button>
                
                <div class="relative" id="profileMenuContainer">
                    <button onclick="toggleProfileDropdown()" class="bg-emerald-600 hover:bg-emerald-700 p-2 rounded-full transition-all hover:scale-105">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </button>
                    
                    <div id="profileDropdown" class="absolute right-0 mt-2 w-48 bg-indigo-800 rounded-lg shadow-xl py-2 z-20 hidden border border-indigo-700">
                        <a onclick="openMissionModal()" class="block px-4 py-2 text-sm text-white hover:bg-indigo-700 cursor-pointer flex items-center gap-2">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.5 10l-4 4-2-2m0 0l-4 4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path></svg>
                             Nuestra Misión
                        </a>
                        <a href="perfil.html" class="block px-4 py-2 text-sm text-white hover:bg-indigo-700 flex items-center gap-2">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                             Perfil Usuario
                        </a>
                        <div class="border-t border-indigo-700 my-1"></div>
                        <a onclick="logout()" class="block px-4 py-2 text-sm text-red-400 hover:bg-indigo-700 cursor-pointer flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-3m0-6V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex items-center space-x-2 md:space-x-4 w-full justify-center">
            <a href="index.html" class="bg-purple-600 hover:bg-purple-700 py-2 px-3 rounded-lg font-bold transition-all text-sm md:text-base hover:scale-105">Temas</a>
            <a href="archivos.html" class="bg-red-600 hover:bg-red-700 py-2 px-3 rounded-lg font-bold transition-all text-sm md:text-base hover:scale-105">Archivos</a>
            <a href="podcast.html" class="bg-pink-600 hover:bg-pink-700 py-2 px-3 rounded-lg font-bold transition-all text-sm md:text-base hover:scale-105">Podcast</a>
        </div>
        
    </div>
</header>

    <main class="container mx-auto p-6">
        
        <section class="mb-12">
            <h2 class="text-4xl font-extrabold text-center mb-8  text-yellow-400 drop-shadow-lg">🏆 Top 3: Lo más votado 🏆</h2>
            <div id="top3Container" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                </div>
        </section>

        <section>
            <h2 class="text-3xl font-bold text-center mb-8 text-teal-400">Resto del Ranking</h2>
            <div id="rankingContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> 
                </div>
        </section>
    </main>
    
    <div id="infoModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-40 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-cyan-900 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto border-2 border-cyan-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-900 p-4 flex justify-end">
                <button onclick="closeInfoModal()" class="hover:bg-indigo-800 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="infoContent" class="p-6 text-white">
                </div>
        </div>
    </div>

    <div id="missionModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-40 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-purple-900 rounded-2xl max-w-xl w-full max-h-[90vh] overflow-y-auto border-2 border-purple-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-800 p-4 flex justify-between items-center border-b border-indigo-600">
                <h2 class="text-xl md:text-2xl font-bold text-white">Nuestra Misión</h2>
                <button onclick="closeMissionModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 text-white space-y-4">
                <p class="text-lg font-semibold text-yellow-300">¡Bienvenidos a Literatura Musical!</p>
                <p>Nuestra misión es conectar dos mundos aparentemente distintos pero profundamente relacionados: la **Literatura Clásica** y la **Música Contemporánea**.</p>
                <p>A través de adaptaciones musicales de obras icónicas, buscamos:</p>
                <ul class="list-disc list-inside space-y-2 ml-4 text-cyan-200">
                    <li>**Rejuvenecer** la apreciación por los grandes autores y sus textos.</li>
                    <li>Ofrecer una **experiencia sensorial única** que complemente la lectura.</li>
                    <li>Crear una **comunidad de votación** donde los usuarios decidan qué adaptaciones merecen estar en la cima.</li>
                    <li>**Incentivar el aprendizaje** de forma lúdica a través de los Quizzes.</li>
                    </ul>
                <p class="pt-4 text-sm text-gray-400">¡Gracias por formar parte de esta sinfonía de letras y melodías!</p>
            </div>
        </div>
    </div>
    
    <div id="globalInfoModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-40 p-4">
        <div class="bg-gradient-to-br from-indigo-950 to-indigo-800 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border-2 border-yellow-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-900 p-4 flex justify-between items-center border-b border-indigo-700">
                <h2 class="text-2xl font-bold text-yellow-400 flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Información y Comunidad
                </h2>
                <button onclick="closeGlobalInfoModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6 text-white space-y-8">
                
                <section class="border-b border-indigo-700 pb-6">
                    <h3 class="text-xl font-bold mb-3 text-teal-400 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                        Mecánica de Votación
                    </h3>
                    <ul class="list-disc list-inside space-y-2 ml-4 text-gray-300">
                        <li>Cada usuario dispone de **5 votos semanales** (límite en el apartado de votos).</li>
                        <li>Cada voto se realiza gastando una cantidad de estrellas: **5, 6, 7, 8, 9 o 10 estrellas**.</li>
                        <li>**Restricción clave:** Solo se puede votar con una cantidad de estrellas **igual o menor** a las estrellas que tienes acumuladas.</li>
                        <li>Las estrellas elegidas para votar se **restan** de tus estrellas acumuladas.</li>
                        <li>Tus votos restantes y estrellas acumuladas se muestran en la cabecera.</li>
                    </ul>
                </section>
                
                <section class="border-b border-indigo-700 pb-6">
                    <h3 class="text-xl font-bold mb-3 text-teal-400 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 002-2h2a2 2 0 002 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        Mecánica de Quiz y Estrellas Acumuladas
                    </h3>
                    <ul class="list-disc list-inside space-y-2 ml-4 text-gray-300">
                        <li>El **título**, **autor** y **año** de la obra están ocultos inicialmente.</li>
                        <li>Debes hacer clic en el botón **HACER QUIZZ** para participar.</li>
                        <li class="font-bold text-yellow-300">La información detallada se desbloquea si aciertas **1 o más preguntas**.</li>
                        <li>Los datos se guardan: una vez desbloqueada la información de una obra, se mantiene visible en el ranking.</li>
                        <li class="font-bold text-teal-400">Estrellas Acumuladas (Moneda):</li>
                        <ul class="list-disc list-inside ml-8 text-cyan-300">
                            <li>Se ganan **5 estrellas** por cada pregunta acertada.</li>
                            <li>Se ganan **10 estrellas mas de bonificación** si aciertas las 5 preguntas (máximo 35 estrellas).</li>
                            <li>Estas estrellas se acumulan en tu saldo (apartado Estrellas) para poder gastarlas en votos.</li>
                        </ul>
                    </ul>
                </section>

                <section>
                    <h3 class="text-xl font-bold mb-4 text-teal-400 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.208 5 7.5 5c-4.418 0-8 3.582-8 8s3.582 8 8 8 8-3.582 8-8c0-1.708-.477-3.332-1.253-4.75z"></path></svg>
                        Muro de Comentarios Globales
                    </h3>
                    <p class="text-sm text-gray-400 mb-4">¡Comparte tus pensamientos generales sobre la web o la música aquí!</p>
                    
                    <div class="mb-6">
                        <textarea id="globalCommentInput" placeholder="Añade un comentario global..." class="w-full bg-indigo-900/50 border border-indigo-600 rounded-lg p-3 text-white placeholder-indigo-400 focus:outline-none focus:border-indigo-400" rows="3"></textarea>
                        <button onclick="addGlobalComment()" class="mt-2 bg-pink-600 hover:bg-pink-700 px-4 py-2 rounded-lg font-bold transition">Añadir Comentario</button>
                    </div>
                    
                    <div id="globalCommentsContainer" class="space-y-3">
                        <p class="text-center text-gray-500 italic" id="noGlobalCommentsMessage">No hay comentarios aún. ¡Sé el primero en comentar!</p>
                    </div>
                </section>
                
            </div>
        </div>
    </div>
    
    <div id="voteSelectionModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-40 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-emerald-900 rounded-2xl max-w-sm w-full border-2 border-emerald-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-900 p-4 flex justify-between items-center border-b border-indigo-700">
                <h2 class="text-xl font-bold text-emerald-400">Elige la Cantidad de Estrellas para Votar</h2>
                <button onclick="closeVoteSelectionModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 text-white space-y-4">
                <p class="text-lg mb-4">Tienes **<span id="userStarsInModal" class="text-yellow-400 font-bold">0</span>** Estrellas Acumuladas.</p>
                <div id="voteOptionsContainer" class="grid grid-cols-3 gap-2">
                    </div>
                <p class="text-sm text-gray-400 pt-2">Solo puedes seleccionar valores de estrella que puedas pagar con tus estrellas acumuladas.</p>
            </div>
        </div>
    </div>


    <div id="lyricsModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-40 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-yellow-900 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border-2 border-yellow-400 shadow-2xl">
             <div class="sticky top-0 bg-indigo-900 p-4 flex justify-between items-center border-b border-indigo-700">
                <h2 class="text-2xl font-bold text-yellow-400" id="lyricsTitle">Letra de la Canción</h2> 
                <button onclick="closeLyricsModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="lyricsContent" class="p-6 text-white whitespace-pre-wrap font-serif">
                </div>
        </div>
    </div>
    
    <div id="quizModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-red-900 rounded-2xl max-w-xl w-full max-h-[90vh] overflow-y-auto border-2 border-red-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-900 p-4 flex justify-between items-center border-b border-indigo-700">
                <h2 class="text-2xl font-bold text-red-400" id="quizTitle">Quiz de la Obra</h2>
                <button onclick="closeQuizModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="quizContent" class="p-6 text-white space-y-6">
                </div>
        </div>
    </div>


    <script>
        // --- DATA DE CANCIONES (BASE) ---
        var initialSongs = [
            { id: 1, title: "Veinte Poemas de Amor", author: "Pablo Neruda", year: 1924, genre: "Poesía Lírica", image: "imagenportada/poemas.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1rDezgL9BLhX3x_u3WQnwIylyVQL3jraH/view?usp=sharing", description: "Adaptación musical de los icónicos versos de amor de Neruda, transformando su melancolía en melodía.", comments: [], lyrics: `Para mi corazón basta tu pecho,
            Para tu libertad bastan mis alas.
            Desde mi boca llegará hasta el cielo
            lo que estaba dormido sobre tu alma.
            
            Es la hora de la partida, la dura y fría hora
            que la noche sujeta a todo horario.
            El cuerpo de la amada se queda conmigo,
            su ausencia ha sembrado la casa de dudas.`, quizData: { correctPrize: "Premio Nobel de Literatura" }, unlocked: false },
            
            { id: 2, title: "Romancero Gitano", author: "Federico García Lorca", year: 1928, genre: "Poesía Lírica", image: "imagenportada/romancero.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1gjwNaLyF9pcyDi3hAnp8mC242AOSisWH/view?usp=drive_link", description: "La pasión flamenca de Lorca convertida en una experiencia musical única e inolvidable. Poema: Romance de la luna, luna", comments: [], lyrics: `La luna vino a la fragua
            con su polisón de nardos.
            El niño la mira mira.
            El niño la está mirando.
            
            En el aire conmovido
            mueve la luna sus brazos
            y enseña, lúbrica y pura,
            sus senos de duro estaño.`, quizData: { correctPrize: "Ninguno" }, unlocked: false },
            
            { id: 3, title: "Canción del Pirata", author: "José de Espronceda", year: 1840, genre: "Poesía Lírica", image: "imagenportada/cancionpirata.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1tw_b57Ta0etgoN_miF4eLOEjAx2TGN6a/view?usp=sharing", description: "La libertad y aventura del romanticismo español en una composición musical épica.", comments: [], lyrics: `Con diez cañones por banda,
            viento en popa, a toda vela,
            no corta el mar, sino vuela,
            un velero bergantín.
            
            Bajel pirata que llaman
            por su bravura el Temido,
            en todo mar conocido
            del uno al otro confín.`, quizData: { correctPrize: "Ninguno" }, unlocked: false },
            
            { id: 4, title: "Campos de Castilla", author: "Antonio Machado", year: 1912, genre: "Poesía Lírica", image: "imagenportada/campos.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1Ciam4_Yijz1Eobkex1P4RCRLr07nTHX-/view?usp=drive_link", description: "Los paisajes castellanos de Machado cobran vida en una melodía contemplativa y profunda.", comments: [], lyrics: `Mi infancia son recuerdos de un patio de Sevilla,
y un huerto claro donde madura el limonero;
mi juventud, veinte años en tierra de Castilla;
mi historia, algunos casos que recordar no quiero.
   Ni un seductor Mañara, ni un Bradomín he sido,
-ya conocéis mi torpe aliño indumentario-
mas recibí la flecha que me asignó Cupido,
y amé cuanto ellas pueden tener de hospitalario.
   Hay en mis venas gotas de sangre jacobina;
pero mi verso brota de manantial sereno;
y, más que un hombre al uso que sabe su doctrina,
soy, en el buen sentido de la palabra, bueno.
   Adoro la hermosura, y en la moderna estética
corté las viejas rosas del huerto de Ronsard;
mas no amo los afeites de la actual cosmética,
ni soy un ave de esas del nuevo gay-trinar.
   Desdeño las romanzas de los tenores huecos
y el coro de los grillos que cantan á la luna.
A distinguir me paro las voces de los ecos,
y escucho solamente entre las voces, una.
   ¿Soy clásico ó romántico? No sé. Dejar quisiera
mi verso, como deja el capitán su espada,
famosa por la mano viril que la blandiera,
no por el docto oficio del forjador preciada.
   Converso con el hombre que siempre va conmigo;
-quien habla solo, espera hablar á Dios un día-
mi soliloquio es plática con este buen amigo
que me enseñó el secreto de la filantropía.
   Y al cabo, nada os debo; debéisme cuanto he escrito.
A mi trabajo acudo, con mi dinero pago
el traje que me cubre y la mansión que habito,
el pan que me alimenta y el lecho en donde yago.
   Y cuando llegue el día del último viaje
y esté al partir la nave que nunca ha de tornar,
me encontraréis á bordo, ligero de equipaje,
casi desnudo, como los hijos de la mar.`, quizData: { correctPrize: "Ninguno" }, unlocked: false },
            
            { id: 5, title: "Altazor", author: "Vicente Huidobro", year: 1931, genre: "Poesía Vanguardista", image: "imagenportada/altazor.png", totalStars: 0, youtubeUrl: "https://youtu.be/Nqo1WXHvjoI?si=TDlmUXkYrf-Xcrq", driveUrl: "https://drive.google.com/file/d/1AcgtWTs8pOFsdRBvKBHisPX_HkXw2ORK/view?usp=drive_link", description: "La vanguardia poética transformada en una experiencia sonora experimental y revolucionaria.", comments: [], lyrics: `No hay tiempo que perder.
            Vamos a la luna o al sol,
            o donde sea,
            donde las manos puedan cortar
            la vida del instante
            que se abre en las manos del hombre.`, quizData: { correctPrize: "Premio Nacional de Literatura de Chile" }, unlocked: false },
            
            { id: 6, title: "Trilce", author: "César Vallejo", year: 1922, genre: "Poesía Vanguardista", image: "imagenportada/trilce.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1ArrRC6iAOXmFBsJUw5gMCRWfHLD_MIwx/view?usp=drive_link", description: "La innovación lingüística de Vallejo encuentra su expresión en armonías sorprendentes.", comments: [], lyrics: `Quién hace tanta bulla y ni deja
            testar las únicas herencias.
            Y quien de una simple trenza
            hace toda una madeja.
            
            Día y noche, día y noche
            sin darnos un respiro, un desvelo.
            El hambre en el vientre del cielo.`, quizData: { correctPrize: "Ninguno" }, unlocked: false },
            
            { id: 7, title: "La Voz a Ti Debida", author: "Pedro Salinas", year: 1933, genre: "Poesía Lírica", image: "imagenportada/lavoz.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/17dRJL2X7fq5rlRn6ho-KsSETGs5Qkeb2/view?usp=drive_link", description: "El amor puro de Salinas convertido en una balada contemporánea llena de sentimiento.", comments: [], lyrics: `Tú vives siempre en tus actos.
            Con la muerte, el telón
            bajo el cual la vida.
            Si, pero es una vida sin ti,
            sin el que tú eras.
            Es la vida en su forma
            más triste, su forma
            de recuerdo.`, quizData: { correctPrize: "Ninguno" }, unlocked: false },
            
            { id: 8, title: "Residencia en la Tierra", author: "Pablo Neruda", year: 1935, genre: "Poesía Surrealista", image: "imagenportada/residencia.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1NtevvMlrWrlanbsIpIEpZYpf2fHNdfNC/view?usp=drive_link", description: "La angustia existencial nerudiana transmutada en composiciones oscuras y evocadoras.", comments: [], lyrics: `Barcarola.
            Si solamente me dieras
            la noche, la noche oscura.
            Y si solamente dieras
            el mar con sus olas furiosas,
            yo sería feliz.
            
            Pero me das la luz,
            la luna y el sol,
            y el tiempo.`, quizData: { correctPrize: "Premio Nobel de Literatura" }, unlocked: false },
            
            { id: 9, title: "Poeta en Nueva York (Vuelta de paseo)", author: "Federico García Lorca", year: 1940, genre: "Poesía Surrealista", image: "imagenportada/poeta.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1-9_6Om33P7uIMcHgNWYgws2zmHUeuqKB/view?usp=drive_link", description: "El surrealismo urbano de Lorca en la gran manzana, ahora en ritmos modernos.", comments: [], lyrics: `Asesinado por el cielo,
            entre las formas que van hacia la sierpe
            y las formas que buscan el cristal.
            
            Dejaré crecer mis cabellos.
            Dejaré crecer mis uñas.
            Iré al mar con el traje roto,
            y el corazón destrozado.`, quizData: { correctPrize: "Ninguno" }, unlocked: false },
            
            { id: 10, title: "Marinero en Tierra", author: "Rafael Alberti", year: 1925, genre: "Poesía Lírica", image: "imagenportada/marinero.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1RoOZ6YiILZbmaQWX2-_4FGE_fuKyW1xB/view?usp=drive_link", description: "La nostalgia marinera de Alberti navega en melodías que evocan el Mediterráneo.", comments: [], lyrics: `Yo, marinero, en la ribera mía,
            navegando sin mar y sin navío.
            Caminando sobre el sol y el frío
            de la sed y el recuerdo.
            
            Daría por el mar de la mañana
            la orilla de la tierra.
            Daría por la sombra de una barca
            esta llanura yerma.`, quizData: { correctPrize: "Premio Cervantes" }, unlocked: false }
        ];

        var songs = []; 
        var votesRemaining = 5; // NUEVO: Límite de 5 votos
        var userStars = 0; // NUEVO: Moneda del usuario (acumuladas del Quiz)
        var totalStarsCount = 0; // Total de estrellas acumuladas por TODAS las canciones
        var selectedSongId = null; // ID de la canción para Quiz o votación
        var lastUpdateDate = null; 
        
        // DATA: COMENTARIOS GLOBALES
        var globalComments = [];
        
        // --- LOCAL STORAGE FUNCTIONS ---
        function saveAppData() {
            localStorage.setItem('literatura_songs', JSON.stringify(songs));
            localStorage.setItem('literatura_votesRemaining', votesRemaining); // Guardar votos restantes
            localStorage.setItem('literatura_lastUpdateDate', lastUpdateDate ? lastUpdateDate.toISOString() : null);
            localStorage.setItem('literatura_userStars', userStars); // Guardar estrellas del usuario (moneda)
            localStorage.setItem('literatura_globalComments', JSON.stringify(globalComments)); 
            localStorage.setItem('literatura_totalStars', totalStarsCount); // Guardar totalStarsCount de las canciones
        }

        function loadAppData() {
            const savedSongs = localStorage.getItem('literatura_songs');
            const savedVotes = localStorage.getItem('literatura_votesRemaining'); // Cargar votos restantes
            const savedDate = localStorage.getItem('literatura_lastUpdateDate');
            const savedUserStars = localStorage.getItem('literatura_userStars'); // Cargar estrellas del usuario
            const savedGlobalComments = localStorage.getItem('literatura_globalComments');
            const savedTotalStars = localStorage.getItem('literatura_totalStars');

            songs = savedSongs ? JSON.parse(savedSongs) : initialSongs;
            votesRemaining = savedVotes !== null && !isNaN(parseInt(savedVotes)) ? parseInt(savedVotes) : 5;
            userStars = savedUserStars !== null && !isNaN(parseInt(savedUserStars)) ? parseInt(savedUserStars) : 0; // Inicializar userStars
            globalComments = savedGlobalComments ? JSON.parse(savedGlobalComments) : [];
            totalStarsCount = savedTotalStars !== null && !isNaN(parseInt(savedTotalStars)) ? parseInt(savedTotalStars) : 0;
            lastUpdateDate = savedDate && savedDate !== 'null' ? new Date(savedDate) : new Date();

            // Mapeo y saneamiento de datos al cargar (INCLUYE MIGRACION DE totalVotes a totalStars)
            songs = songs.map(song => {
                if (!song.comments) song.comments = []; 
                
                // MIGRACION: totalVotes a totalStars
                if (typeof song.totalStars === 'undefined') {
                    if (typeof song.totalVotes !== 'undefined') {
                        song.totalStars = song.totalVotes;
                        delete song.totalVotes;
                    } else {
                        song.totalStars = 0;
                    }
                }
                
                if (typeof song.unlocked === 'undefined') {
                    const initialSong = initialSongs.find(s => s.id === song.id);
                    song.unlocked = initialSong ? initialSong.unlocked : false;
                }
                
                // Sincronizar quizData y genre (asegura que se añadan los nuevos campos si faltan)
                const initialSong = initialSongs.find(s => s.id === song.id);
                if (initialSong) {
                    song.quizData = initialSong.quizData;
                    if (typeof song.genre === 'undefined') {
                        song.genre = initialSong.genre;
                    }
                }
                
                return song;
            });

            // Si el array de canciones guardado es más corto que el inicial
            if (songs.length < initialSongs.length) {
                const existingIds = new Set(songs.map(s => s.id));
                initialSongs.forEach(newSong => {
                    if (!existingIds.has(newSong.id)) {
                        songs.push(newSong);
                    }
                });
            }
            
            // Recalcular totalStarsCount (solo si es necesario, para asegurar)
            if (totalStarsCount === 0 && songs.some(s => s.totalStars > 0)) {
                 totalStarsCount = songs.reduce((sum, song) => sum + (song.totalStars || 0), 0);
            }

            // Actualizar la cabecera
            document.getElementById('votesRemainingDisplay').textContent = votesRemaining;
            document.getElementById('userStarsDisplay').textContent = userStars;
        }

        // --- FUNCIONES DEL MENÚ DE PERFIL ---

        function toggleProfileDropdown() {
            document.getElementById('profileDropdown').classList.toggle('hidden');
        }

        // --- FUNCIONES DE COMENTARIOS GLOBALES ---
        
        function addGlobalComment() {
            var globalCommentInput = document.getElementById('globalCommentInput');
            var text = globalCommentInput.value.trim();
            if (text === "") return;

            var newComment = {
                text: text,
                timestamp: new Date().toLocaleString(),
                user: "Usuario Anónimo"
            };

            globalComments.unshift(newComment);
            globalCommentInput.value = '';
            saveAppData();
            renderGlobalComments();
        }

        function renderGlobalComments() {
            var globalCommentsContainer = document.getElementById('globalCommentsContainer');
            if (!globalCommentsContainer) return;

            if (globalComments.length === 0) {
                globalCommentsContainer.innerHTML = '<p class="text-center text-gray-500 italic" id="noGlobalCommentsMessage">No hay comentarios aún. ¡Sé el primero en comentar!</p>';
                return;
            }

            var globalCommentsHtml = globalComments.map(comment => {
                const userName = comment.user || 'Usuario Anónimo';
                return '<div class="bg-indigo-700/50 p-3 rounded-lg border border-indigo-500"><p class="text-xs font-semibold text-yellow-300">' + userName + ' (' + comment.timestamp + ')</p><p class="text-base">' + comment.text + '</p></div>';
            }).join('');
            
            globalCommentsContainer.innerHTML = globalCommentsHtml;
        }

        // --- FUNCIONES DE MODALES ---

        function openGlobalInfoModal() {
            document.getElementById('globalInfoModal').classList.remove('hidden');
            renderGlobalComments(); // Asegura que los comentarios se carguen al abrir el modal
        }

        function closeGlobalInfoModal() {
            document.getElementById('globalInfoModal').classList.add('hidden');
        }
        
        function closeInfoModal() {
            document.getElementById('infoModal').classList.add('hidden');
            selectedSongId = null;
        }

        function openMissionModal() {
            document.getElementById('profileDropdown').classList.add('hidden');
            document.getElementById('missionModal').classList.remove('hidden');
        }
        
        function closeMissionModal() {
            document.getElementById('missionModal').classList.add('hidden');
        }

        function closeVoteSelectionModal() {
            document.getElementById('voteSelectionModal').classList.add('hidden');
            selectedSongId = null;
        }
        
        function logout() {
            alert("Has cerrado sesión. Redireccionando...");
        }


        // --- FUNCIONES DEL RANKING Y VOTOS ---

        function checkAndResetWeeklyData() {
            var today = new Date();
            // Comprobación simple de si ha pasado una semana (7 días)
            if (!lastUpdateDate || (today.getTime() - lastUpdateDate.getTime()) > (7 * 24 * 60 * 60 * 1000)) {
                votesRemaining = 5; // Reinicia el límite de 5 votos
                lastUpdateDate = today;
                document.getElementById('votesRemainingDisplay').textContent = votesRemaining;
                saveAppData();
                return;
            }
        }
        
        /**
         * NUEVA FUNCIÓN: Muestra el modal para que el usuario elija la cantidad de estrellas a votar.
         */
        function openVoteSelectionModal(songId) {
            if (votesRemaining <= 0) {
                 alert("Has alcanzado el límite de 5 votos por semana. Vuelve la próxima semana.");
                 return;
            }
            
            selectedSongId = songId;
            document.getElementById('userStarsInModal').textContent = userStars;
            const voteOptionsContainer = document.getElementById('voteOptionsContainer');
            voteOptionsContainer.innerHTML = '';
            
            const voteValues = [5, 6, 7, 8, 9, 10];
            
            voteValues.forEach(value => {
                const canAfford = userStars >= value;
                const buttonClass = canAfford 
                    ? 'bg-emerald-500 hover:bg-emerald-600 cursor-pointer' 
                    : 'bg-gray-600 cursor-not-allowed opacity-50';
                    
                voteOptionsContainer.innerHTML += `
                    <button 
                        class="p-3 rounded-lg font-bold transition ${buttonClass}" 
                        ${canAfford ? `onclick="submitVote(${value})"` : 'disabled'}
                    >
                        ${value} ⭐
                    </button>
                `;
            });
            
            document.getElementById('voteSelectionModal').classList.remove('hidden');
        }

        /**
         * NUEVA FUNCIÓN: Procesa el voto con la cantidad de estrellas elegida.
         */
        function submitVote(stars) {
            if (votesRemaining <= 0) {
                 alert("Error: No tienes votos restantes.");
                 closeVoteSelectionModal();
                 return;
            }
            
            if (userStars < stars) {
                alert("Error: No tienes suficientes estrellas para este voto.");
                 closeVoteSelectionModal();
                return;
            }
            
            const songIndex = songs.findIndex(s => s.id === selectedSongId);
            if (songIndex === -1) {
                alert("Error: Canción no encontrada.");
                 closeVoteSelectionModal();
                return;
            }
            
            // 1. Restar estrellas del usuario
            userStars -= stars;
            document.getElementById('userStarsDisplay').textContent = userStars;
            
            // 2. Sumar estrellas a la canción
            songs[songIndex].totalStars += stars;
            
            // 3. Restar voto restante
            votesRemaining--;
            document.getElementById('votesRemainingDisplay').textContent = votesRemaining;
            
            // 4. Actualizar ranking y guardar
            saveAppData();
            renderRanking();
            
            alert(`¡Voto realizado con éxito! Se han gastado ${stars} estrellas. Te quedan ${votesRemaining} votos esta semana.`);
            closeVoteSelectionModal();
        }

        function renderRanking() {
            // 1. Ordenar por totalStars (descendente)
            songs.sort((a, b) => b.totalStars - a.totalStars);

            const top3Container = document.getElementById('top3Container');
            const rankingContainer = document.getElementById('rankingContainer');
            
            top3Container.innerHTML = '';
            rankingContainer.innerHTML = '';
            
            // 2. Renderizar Top 3
            songs.slice(0, 3).forEach((song, index) => {
                const position = index + 1;
                // El Top 3 usa el indicador isTop3=true para cambiar el color del badge de posición
                const topCard = createSongCard(song, position, true); 
                top3Container.innerHTML += topCard;
            });

            // 3. Renderizar Resto del Ranking
            songs.slice(3).forEach((song, index) => {
                const position = index + 4;
                const card = createSongCard(song, position, false); // El resto del ranking no es Top3, se pasa 'false'
                rankingContainer.innerHTML += card;
            });
            
            // 4. Actualizar contadores de estrellas en la cabecera (esto se hace en loadAppData, pero lo repetimos por si acaso)
            document.getElementById('votesRemainingDisplay').textContent = votesRemaining;
            document.getElementById('userStarsDisplay').textContent = userStars;
        }

        function createSongCard(song, position, isTop3 = false) {
            const starIcon = '<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>';
            const defaultImage = song.image || 'imagenportada/default.png'; 
            
            // Color del badge: El #1 y el resto usan indigo-600, solo #2 y #3 son diferentes.
            const badgeClass = isTop3 
                ? (position === 1 ? 'bg-indigo-600' : (position === 2 ? 'bg-gray-400' : 'bg-amber-700')) 
                : 'bg-indigo-600';
                
            // MODIFICACIÓN CLAVE: Se unifica la clase de la tarjeta para usar el estilo general de fondo y hover.
            // Elimina el fondo 'bg-indigo-800' y el hover 'hover:shadow-xl' de las Top 3.
            const cardClass = 'bg-gray-800 border border-gray-700 hover:bg-gray-700 flex flex-col';

            // Contenido dinámico (oculto o revelado)
            const isUnlocked = song.unlocked;
            const hiddenInfo = `<span class="text-red-400 font-bold">OCULTO</span>`;
            const titleDisplay = isUnlocked ? song.title : 'Obra Misteriosa'; 
            const infoDisplay = isUnlocked 
                ? `
                    <p class="text-base text-gray-300">Autor: <span class="font-semibold text-teal-400">${song.author}</span></p>
                    <p class="text-base text-gray-300">Año: <span class="font-semibold text-teal-400">${song.year}</span></p>
                  `
                : `
                    <p class="text-base text-gray-300">Autor: ${hiddenInfo}</p>
                    <p class="text-base text-gray-300">Año: ${hiddenInfo}</p>
                    <button onclick="openQuizModal(${song.id})" class="mt-2 w-full bg-red-600 hover:bg-red-700 py-2 rounded-lg font-bold transition-all hover:scale-[1.02]">HACER QUIZZ</button>
                  `;
            
            // MODIFICACION: Reproductor de audio a botón de Drive
            const audioButton = `
                <div class="mb-4 text-center">
                    <a href="${song.driveUrl}" target="_blank" class="bg-teal-600 hover:bg-teal-700 p-3 rounded-full transition-all hover:scale-110 inline-flex items-center shadow-lg" title="Escuchar Audio (Drive)">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M3 10v4c0 1.1.9 2 2 2h3l3.29 3.29c.63.63 1.71.18 1.71-.71V7.41c0-.89-1.08-1.34-1.71-.71L8 8H5c-1.1 0-2 .9-2 2zm13.5-2v8c1.69 0 3.26-.7 4.41-1.85a.999.999 0 000-1.41C19.76 12.7 18.19 12 16.5 12c1.69 0 3.26-.7 4.41-1.85a.999 0 000-1.41C19.76 8.7 18.19 8 16.5 8z"></path>
                        </svg>
                        <span class="sr-only">Escuchar Audio</span>
                    </a>
                </div>
            `;


            return `
                <div class="${cardClass} rounded-xl overflow-hidden shadow-lg relative">
                    <div class="absolute top-0 left-0 ${badgeClass} text-white font-black text-lg p-2 rounded-br-lg z-10 shadow-lg flex items-center gap-1">
                        ${isTop3 ? '<span class="text-xl">' + position + '</span>' : position} 
                    </div>
                    
                    <div class="image-placeholder h-48 w-full bg-cover bg-center" style="background-image: url('${defaultImage}')">
                        </div>
                    
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-2xl font-bold mb-2 ${isUnlocked ? 'text-yellow-400' : 'text-cyan-400'}">${titleDisplay}</h3>
                        
                        ${audioButton}
                        
                        <p class="text-sm text-gray-400 mb-4">${song.description}</p>
                        
                        <div class="border-t border-indigo-700 pt-3 mb-4">
                            ${infoDisplay}
                        </div>
                        
                        <div class="mt-auto pt-3 border-t border-indigo-700 flex items-center justify-between">
                            <div class="flex items-center space-x-1 text-yellow-400 font-bold text-lg">
                                ${starIcon}
                                <span>${song.totalStars} Estrellas</span>
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <a href="${song.youtubeUrl}" target="_blank" class="bg-red-700 hover:bg-red-800 p-2 rounded-full transition-all hover:scale-110" title="Ver en YouTube">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.64-1.34-7.28-1.34-10.92 0C4.372 4.524 2.82 6.84 2.11 9.47 1.4 12.1 1.4 14.9 2.11 17.53c.71 2.63 2.262 4.946 6.585 6.286 3.64 1.34 7.28 1.34 10.92 0 4.323-1.34 5.875-3.656 6.585-6.286.71-2.63.71-5.43 0-8.06-.71-2.63-2.262-4.946-6.585-6.286zM10 16.5v-9l6 4.5-6 4.5z"></path></svg>
                                </a>
                                <button onclick="openLyricsModal(${song.id})" class="bg-purple-700 hover:bg-purple-800 p-2 rounded-full transition-all hover:scale-110" title="Ver Letra">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                                </button>
                                <button onclick="openVoteSelectionModal(${song.id})" class="bg-emerald-600 hover:bg-emerald-700 px-3 py-2 rounded-lg font-bold transition-all hover:scale-105 flex items-center gap-1" title="Votar">
                                     Votar
                                </button>
                            </div>
                        </div>
                        
                    </div>
                </div>
            `;
        }
        
        // --- FUNCIONES PARA MODAL DE LETRAS ---
        
        function openLyricsModal(songId) {
            const song = songs.find(s => s.id === songId);
            if (!song) return;

            document.getElementById('lyricsTitle').textContent = `Letra de: ${song.title}`;
            document.getElementById('lyricsContent').textContent = song.lyrics || 'Letra no disponible.';
            document.getElementById('lyricsModal').classList.remove('hidden');
        }

        function closeLyricsModal() {
            document.getElementById('lyricsModal').classList.add('hidden');
        }


        // --- FUNCIONES PARA MODAL DE QUIZ (MODIFICADAS PARA 5 PREGUNTAS) ---
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function createQuizQuestion(question, options, correctAnswer, questionNumber) {
            // Asegura que la respuesta correcta esté entre las opciones y mezcla
            let optionsSet = new Set(options.filter(opt => opt !== null && opt !== undefined && opt !== ''));
            optionsSet.add(correctAnswer); // Asegura que la respuesta correcta esté incluida
            
            let finalOptions = Array.from(optionsSet);
            // Si hay más de 3, limita a 3 opciones, incluyendo la correcta y dos aleatorias
            if (finalOptions.length > 3) {
                finalOptions = shuffleArray(finalOptions.filter(opt => opt !== correctAnswer)).slice(0, 2);
                finalOptions.push(correctAnswer);
            }
            
            const shuffledOptions = shuffleArray(finalOptions);


            const optionsHtml = shuffledOptions.map((option, index) => `
                <label class="flex items-center p-3 bg-indigo-700/50 rounded-lg hover:bg-indigo-600 transition cursor-pointer">
                    <input type="radio" name="question${questionNumber}" value="${option}" class="form-radio h-5 w-5 text-red-400">
                    <span class="ml-3 text-lg">${option}</span>
                </label>
            `).join('');

            return `
                <div class="p-4 bg-indigo-800 rounded-xl border border-indigo-600 shadow-inner">
                    <p class="text-xl font-semibold mb-4 text-yellow-300">Pregunta ${questionNumber}: ${question}</p>
                    <div class="space-y-2">
                        ${optionsHtml}
                    </div>
                    <input type="hidden" id="correctAnswer${questionNumber}" value="${correctAnswer}">
                </div>
            `;
        }
        
        function generateQuizQuestions(song, songs) {
            const quizData = song.quizData;
            
            // Recolectar distractores
            const allAuthors = [...new Set(songs.map(s => s.author))].filter(a => a !== song.author);
            const allYears = [...new Set(songs.map(s => s.year))].filter(y => y !== song.year);
            const allTitles = [...new Set(songs.map(s => s.title))].filter(t => t !== song.title);
            const allGenres = [...new Set(songs.map(s => s.genre))].filter(g => g !== song.genre);
            
            // Q1: Autor
            const options1 = shuffleArray([song.author, ...allAuthors]).slice(0, 3);
            const q1 = createQuizQuestion('¿Quién es el autor de esta obra literaria?', options1, song.author, 1);
            
            // Q2: Título de la obra
            const options2 = shuffleArray([song.title, ...allTitles]).slice(0, 3);
            const q2 = createQuizQuestion('¿Cuál es el título exacto de esta obra o libro?', options2, song.title, 2);
            
            // Q3: Año de publicación
            const options3 = shuffleArray([song.year.toString(), ...allYears.map(y => y.toString())]).slice(0, 3);
            const q3 = createQuizQuestion('¿En qué año fue publicada originalmente la obra?', options3, song.year.toString(), 3);
            
            // Q4: Tipo de obra/Género
            const genreDistractors = ["Novela Histórica", "Ensayo Filosófico", "Teatro Clásico"].filter(g => g !== song.genre);
            const options4 = shuffleArray([song.genre, ...allGenres, ...genreDistractors]).slice(0, 3);
            const q4 = createQuizQuestion('¿Qué tipo de género literario representa esta obra?', options4, song.genre, 4);

            // Q5: Premio del Autor
            // Usamos una selección de premios conocidos como distractores.
            const prizeDistractors = ['Premio Planeta', 'Premio Goya', 'Premio Pulitzer', 'Premio Rómulo Gallegos'].filter(p => p !== quizData.correctPrize);
            const options5 = shuffleArray([quizData.correctPrize, ...prizeDistractors]).slice(0, 3);
            const q5 = createQuizQuestion('¿Qué premio de prestigio ganó el autor por esta obra o es mayormente conocido?', options5, quizData.correctPrize, 5);
            
            return [q1, q2, q3, q4, q5].join('');
        }


        function openQuizModal(songId) {
            const song = songs.find(s => s.id === songId);
            if (!song) return;
            
            selectedSongId = songId;
            
            document.getElementById('quizTitle').textContent = `Quiz: ¿Qué sabes de "${song.title}"?`;
            const quizContent = document.getElementById('quizContent');
            quizContent.innerHTML = ''; // Limpiar contenido anterior

            // Generar las 5 preguntas
            quizContent.innerHTML = generateQuizQuestions(song, songs) + `
                <div class="flex justify-end">
                    <button onclick="submitQuiz()" class="bg-red-500 hover:bg-red-600 px-6 py-3 rounded-lg font-bold transition-all text-lg hover:scale-105">
                        Finalizar Quiz
                    </button>
                </div>
            `;

            document.getElementById('quizModal').classList.remove('hidden');
        }

        function submitQuiz() {
            const song = songs.find(s => s.id === selectedSongId);
            if (!song) return;

            let correctAnswers = 0;
            const totalQuestions = 5; // MODIFICACION: 5 preguntas

            for (let i = 1; i <= totalQuestions; i++) {
                const selectedOption = document.querySelector(`input[name="question${i}"]:checked`);
                const correctAnswer = document.getElementById(`correctAnswer${i}`).value;

                if (selectedOption && selectedOption.value === correctAnswer) {
                    correctAnswers++;
                }
            }

            // 1. Cálculo de estrellas ganadas
            let starsGained = correctAnswers * 5;
            let bonus = 0;
            let unlockMessage = '';

            if (correctAnswers >= 1 && !song.unlocked) {
                song.unlocked = true; // Desbloquear información
                unlockMessage = '<p class="font-bold text-teal-400 mt-2">¡Información (Título, Autor, Año) de la obra desbloqueada en el ranking!</p>';
            }

            if (correctAnswers === totalQuestions) {
                bonus = 10;
                starsGained += bonus;
                unlockMessage += '<p class="font-bold text-yellow-300 mt-2">¡BONIFICACIÓN! +10 Estrellas por acierto completo (5/5).</p>';
            }

            // 2. Actualizar saldo del usuario
            userStars += starsGained;
            document.getElementById('userStarsDisplay').textContent = userStars;

            // 3. Mostrar resultado
            const resultHtml = `
                <div class="text-center p-6 bg-indigo-700 rounded-xl border-2 border-red-400">
                    <h3 class="text-3xl font-bold text-white mb-4">¡Resultado del Quiz!</h3>
                    <p class="text-2xl font-semibold text-cyan-400">Respuestas Correctas: ${correctAnswers} de ${totalQuestions}</p>
                    <p class="text-xl mt-4 text-yellow-400">Ganaste: <span class="font-bold text-3xl">${starsGained}</span> Estrellas ⭐</p>
                    ${unlockMessage}
                    <p class="text-lg mt-4 text-white">Tu nuevo saldo es: <span class="font-bold text-yellow-400">${userStars}</span> Estrellas.</p>
                </div>
            `;

            document.getElementById('quizContent').innerHTML = resultHtml;

            // 4. Guardar datos y actualizar ranking visual
            saveAppData();
            renderRanking();
            
            // Reemplazar el botón de finalizar con uno de cerrar
            document.getElementById('quizContent').innerHTML += `
                <div class="flex justify-end pt-4">
                    <button onclick="closeQuizModal()" class="bg-indigo-500 hover:bg-indigo-600 px-6 py-3 rounded-lg font-bold transition-all text-lg hover:scale-105">
                        Cerrar
                    </button>
                </div>
            `;
        }


        function closeQuizModal() {
            document.getElementById('quizModal').classList.add('hidden');
            selectedSongId = null;
        }

        // --- INICIALIZACIÓN ---

        function init() {
            loadAppData(); // Cargar datos (incluyendo stars, votesRemaining y lastUpdateDate)
            checkAndResetWeeklyData(); // Comprobar y resetear votos si ha pasado una semana
            renderRanking(); // Renderizar el ranking con los datos cargados
            
            // Listeners para cerrar modales al hacer clic fuera
            document.getElementById('infoModal').addEventListener('click', function(e) {
                if (e.target === this) closeInfoModal();
            });

            document.getElementById('lyricsModal').addEventListener('click', function(e) {
                if (e.target === this) closeLyricsModal(); 
            });

            document.getElementById('quizModal').addEventListener('click', function(e) {
                if (e.target === this) closeQuizModal(); 
            });
            
            document.getElementById('globalInfoModal').addEventListener('click', function(e) {
                if (e.target === this) closeGlobalInfoModal(); 
            });
            
            document.getElementById('missionModal').addEventListener('click', function(e) {
                if (e.target === this) closeMissionModal(); 
            });
            
            document.getElementById('voteSelectionModal').addEventListener('click', function(e) {
                if (e.target === this) closeVoteSelectionModal(); 
            });
            
            // Cierra el menú desplegable si se hace click fuera
            document.addEventListener('click', function(e) {
                const profileDropdown = document.getElementById('profileDropdown');
                const profileMenuContainer = document.getElementById('profileMenuContainer');
                
                if (profileDropdown && !profileMenuContainer.contains(e.target) && !profileDropdown.classList.contains('hidden')) {
                    profileDropdown.classList.add('hidden');
                }
            });
        }

        // Ejecutar la inicialización al cargar la página
        window.onload = init; // <--- CORRECCIÓN CLAVE
    </script>
</body>
</html>